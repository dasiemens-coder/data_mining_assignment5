#!/bin/bash

# --- Configuration Arrays ---
# Graphs to test
GRAPHS=(
    "graphs/add20.graph"
    "graphs/3elt.graph"
    "graphs/twitter.graph"
)

# Delta values (Cooling rate)
DELTAS=(0.003 0.03 0.0003)

# Alpha values (Energy function bias)
ALPHAS=(1.0 2.0 3.0)

# Node Selection Policies
POLICIES=("HYBRID" "LOCAL" "RANDOM")

# Fixed parameters
ROUNDS=400

# Create the plots directory if it doesn't exist
mkdir -p plots
mkdir -p output

echo "=========================================="
echo "Starting Systematic Experiments"
echo "=========================================="

# Helper function for cross-platform timing
get_time_ms() {
    python3 -c 'import time; print(int(time.time() * 1000))'
}

# --- Main Loops ---
for graph in "${GRAPHS[@]}"; do
    for delta in "${DELTAS[@]}"; do
        for alpha in "${ALPHAS[@]}"; do
            for policy in "${POLICIES[@]}"; do

                echo "------------------------------------------"
                echo "Running: $graph | Delta: $delta | Alpha: $alpha | Policy: $policy"
                
                # 1. Start Timer
                START_TIME=$(get_time_ms)

                # 2. Run the simulation (Output suppressed to keep terminal clean)
                ./run.sh \
                    -graph "$graph" \
                    -delta "$delta" \
                    -alpha "$alpha" \
                    -nodeSelectionPolicy "$policy" \
                    -rounds "$ROUNDS" > /dev/null
                
                # 3. End Timer
                END_TIME=$(get_time_ms)
                DURATION=$((END_TIME - START_TIME))
                
                # 4. Handle Result Files
                # Find the latest output file generated by Jabeja
                LATEST_RESULT=$(ls -t output/*.txt | head -n 1)
                
                if [ -z "$LATEST_RESULT" ]; then
                    echo "Error: No output file found!"
                    continue
                fi

                # Copy it to 'output/result' because plot.sh/graph.gnuplot likely expects this specific filename
                cp "$LATEST_RESULT" output/result

                # 5. Generate Plot using plot.sh
                echo "Time: ${DURATION}ms | Plotting..."
                ./plot.sh output/result > /dev/null 2>&1

                # 6. Rename and Move the Plot
                # We assume plot.sh generates a PNG. We find the newest PNG in the directory.
                LATEST_PNG=$(ls -t *.png output/*.png 2>/dev/null | head -n 1)
                
                if [ -f "$LATEST_PNG" ]; then
                    # Construct clean filename
                    GRAPH_NAME=$(basename "$graph" .graph)
                    TARGET_NAME="plots/${GRAPH_NAME}_d${delta}_a${alpha}_np${policy}_t${DURATION}ms.png"
                    
                    mv "$LATEST_PNG" "$TARGET_NAME"
                    echo "Saved plot to: $TARGET_NAME"
                else
                    echo "Warning: Could not find a PNG generated by plot.sh"
                fi

            done
        done
    done
done

echo "=========================================="
echo "All experiments completed."
echo "Plots are saved in the /plots directory."
echo "=========================================="